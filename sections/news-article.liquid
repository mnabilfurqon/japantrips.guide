{{ 'news-article.css' | asset_url | stylesheet_tag }}

<div class="news-article">
  <div class="reading-progress" id="readingProgress"></div>

  <aside class="toc">
    <div class="toc-title">Contents</div>
    <ul id="tocList"></ul>
  </aside>

  <article>
    <div class="article-hero">
      {% if page.metafields.custom.category %}
        <span class="article-category">{{ page.metafields.custom.category }}</span>
      {% endif %}

      <h1 class="article-title">{{ page.title }}</h1>

      {% if page.metafields.global.description_tag or page.description %}
        <p class="article-subtitle">
          {{ page.metafields.global.description_tag | default: page.description }}
        </p>
      {% endif %}

      {% assign word_count = page.content | strip_html | number_of_words %}
      {% assign read_minutes = word_count | divided_by: 200 | at_least: 1 %}

      <div class="article-meta">
        {% if page.metafields.custom.author %}
          <div>By {{ page.metafields.custom.author }}</div>
        {% endif %}
        {% if page.published_at %}
          <div>{{ page.published_at | date: '%B %d, %Y' }}</div>
        {% endif %}
        <div>{{ read_minutes }} min read</div>
      </div>
    </div>

    {% if page.image %}
      <div class="featured-image">
        <img
          srcset="
            {{ page.image | image_url: width: 600 }} 600w,
            {{ page.image | image_url: width: 900 }} 900w,
            {{ page.image | image_url: width: 1200 }} 1200w,
            {{ page.image | image_url: width: 1600 }} 1600w
          "
          sizes="(max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px"
          src="{{ page.image | image_url: width: 1200 }}"
          alt="{{ page.title }}"
          loading="eager"
          width="1200"
          height="675"
        >
      </div>
    {% endif %}

    <div class="article-content">
      {{ page.content }}
    </div>

    <div class="article-footer">
      {% if page.metafields.custom.tags %}
        <div class="article-tags">
          <h4>Tags</h4>
          <div class="tags">
            {% assign tags = page.metafields.custom.tags | split: ',' %}
            {% for tag in tags %}
              <a href="{{ pages['news'].url }}?tag={{ tag | strip | handleize }}" class="tag">{{ tag | strip }}</a>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if page.metafields.custom.author %}
        <div class="author-section">
          <div class="author-avatar"></div>
          <div class="author-info">
            <h4>{{ page.metafields.custom.author }}</h4>
            <p>Travel writer specializing in Japan</p>
          </div>
        </div>
      {% endif %}
    </div>
  </article>

  {% assign related_pages = '' | split: '' %}

  {% if page.metafields.custom.previous_article.value %}
    {% assign related_pages = related_pages | push: page.metafields.custom.previous_article.value %}
  {% endif %}

  {% if page.metafields.custom.next_article.value %}
    {% assign related_pages = related_pages | push: page.metafields.custom.next_article.value %}
  {% endif %}

  {% if page.metafields.custom.article.value %}
    {% assign related_pages = related_pages | push: page.metafields.custom.article.value %}
  {% endif %}

  {% if related_pages.size > 0 %}
    <section class="related-articles">
      <h3>Related Articles</h3>
      <div class="related-grid">
        {% for related in related_pages limit: 3 %}
          <a href="{{ related.url }}" class="related-card">
            <div class="related-card-image">
              {% if related.image %}
                <img
                  srcset="
                    {{ related.image | image_url: width: 300 }} 300w,
                    {{ related.image | image_url: width: 400 }} 400w,
                    {{ related.image | image_url: width: 600 }} 600w
                  "
                  sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 400px"
                  src="{{ related.image | image_url: width: 400 }}"
                  alt="{{ related.title }}"
                  loading="lazy"
                  width="400"
                  height="300"
                >
              {% endif %}
            </div>
            {% if related.metafields.custom.category %}
              <div class="related-card-category">{{ related.metafields.custom.category }}</div>
            {% endif %}
            <h4>{{ related.title }}</h4>
            <p>{{ related.content | strip_html | truncate: 120 }}</p>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const content = document.querySelector('.article-content');
    const tocList = document.getElementById('tocList');
    const headings = content.querySelectorAll('h2');

    headings.forEach((heading, index) => {
      const id = `section-${index}`;
      heading.id = id;

      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = heading.textContent;
      li.appendChild(a);
      tocList.appendChild(li);
    });
  });

  window.addEventListener('scroll', () => {
    const article = document.querySelector('.article-content');
    if (!article) return;
    const progress = ((window.scrollY - article.offsetTop + window.innerHeight) / article.scrollHeight) * 100;
    document.getElementById('readingProgress').style.width = Math.min(Math.max(progress, 0), 100) + '%';
  });

  window.addEventListener('scroll', () => {
    const toc = document.querySelector('.toc');
    const content = document.querySelector('.article-content');
    if (!toc || !content) return;
    if (window.scrollY >= content.offsetTop - 200) {
      toc.classList.add('visible');
    } else {
      toc.classList.remove('visible');
    }
  });

  const updateTOC = () => {
    const sections = document.querySelectorAll('.article-content h2');
    const tocLinks = document.querySelectorAll('.toc a');
    let current = '';

    sections.forEach((section) => {
      if (window.scrollY >= section.offsetTop - 150) {
        current = section.id;
      }
    });

    tocLinks.forEach((link) => {
      link.classList.toggle('active', link.getAttribute('href') === `#${current}`);
    });
  };

  window.addEventListener('scroll', updateTOC);

  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        window.scrollTo({
          top: target.offsetTop - 120,
          behavior: 'smooth',
        });
      }
    });
  });
</script>

{% schema %}
{
  "name": "News Article",
  "settings": []
}
{% endschema %}
