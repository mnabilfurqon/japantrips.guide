{{ 'news-article.css' | asset_url | stylesheet_tag }}

<div class="news-article">
  <div class="reading-progress" id="readingProgress"></div>

  <aside class="toc">
    <div class="toc-title">Contents</div>
    <ul id="tocList"></ul>
  </aside>

  <article>
    <div class="article-hero">
      {% if page.metafields.custom.category %}
        <span class="article-category">{{ page.metafields.custom.category }}</span>
      {% endif %}

      <h1 class="article-title">{{ page.title }}</h1>

      {% if page.metafields.global.description_tag or page.description %}
        <p class="article-subtitle">
          {{ page.metafields.global.description_tag | default: page.description }}
        </p>
      {% endif %}

      {% assign word_count = page.content | strip_html | number_of_words %}
      {% assign read_minutes = word_count | divided_by: 200 | at_least: 1 %}

      <div class="article-meta">
        {% if page.metafields.custom.author %}
          <div>By {{ page.metafields.custom.author }}</div>
        {% endif %}
        {% if page.published_at %}
          <div>{{ page.published_at | date: '%B %d, %Y' }}</div>
        {% endif %}
        <div>{{ read_minutes }} min read</div>
      </div>
    </div>

    {% if page.image %}
      <div class="featured-image">
        <img
          srcset="
            {{ page.image | image_url: width: 600 }} 600w,
            {{ page.image | image_url: width: 900 }} 900w,
            {{ page.image | image_url: width: 1200 }} 1200w,
            {{ page.image | image_url: width: 1600 }} 1600w
          "
          sizes="(max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px"
          src="{{ page.image | image_url: width: 1200 }}"
          alt="{{ page.title }}"
          loading="eager"
          width="1200"
          height="675"
        >
      </div>
    {% endif %}

    <div class="article-content">
      {{ page.content }}
    </div>

    <div class="article-footer">
      {% if page.metafields.custom.tags %}
        <div class="article-tags">
          <h4>Tags</h4>
          <div class="tags">
            {% assign tags = page.metafields.custom.tags | split: ',' %}
            {% for tag in tags %}
              <a href="{{ pages['news'].url }}?tag={{ tag | strip | handleize }}" class="tag">{{ tag | strip }}</a>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if page.metafields.custom.author %}
        <div class="author-section">
          <div class="author-avatar"></div>
          <div class="author-info">
            <h4>{{ page.metafields.custom.author }}</h4>
            <p>{{ page.metafields.custom.author_bio }}</p>
          </div>
        </div>
      {% endif %}
    </div>
  </article>

  {% assign related_pages = '' | split: '' %}

  {% if page.metafields.custom.previous_article.value %}
    {% assign related_pages = related_pages | push: page.metafields.custom.previous_article.value %}
  {% endif %}

  {% if page.metafields.custom.next_article.value %}
    {% assign related_pages = related_pages | push: page.metafields.custom.next_article.value %}
  {% endif %}

  {% if page.metafields.custom.article.value %}
    {% assign related_pages = related_pages | push: page.metafields.custom.article.value %}
  {% endif %}

  {% if related_pages.size > 0 %}
    <section class="related-articles">
      <h3>Related Articles</h3>
      <div class="related-grid">
        {% for related in related_pages limit: 3 %}
          <a href="{{ related.url }}" class="related-card">
            <div class="related-card-image">
              {% if related.image %}
                <img
                  srcset="
                    {{ related.image | image_url: width: 300 }} 300w,
                    {{ related.image | image_url: width: 400 }} 400w,
                    {{ related.image | image_url: width: 600 }} 600w
                  "
                  sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 400px"
                  src="{{ related.image | image_url: width: 400 }}"
                  alt="{{ related.title }}"
                  loading="lazy"
                  width="400"
                  height="300"
                >
              {% endif %}
            </div>
            {% if related.metafields.custom.category %}
              <div class="related-card-category">{{ related.metafields.custom.category }}</div>
            {% endif %}
            <h4>{{ related.title }}</h4>
            <p>{{ related.content | strip_html | truncate: 120 }}</p>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const content = document.querySelector('.article-content');
    const tocList = document.getElementById('tocList');
    const progressEl = document.getElementById('readingProgress');
    const tocEl = document.querySelector('.toc');

    if (!content) return;

    content.querySelectorAll('p').forEach((p) => {
      const raw = (p.textContent || '').trim();
      const lower = raw.toLowerCase();

      if (lower.startsWith('[caption]')) {
        p.classList.add('image-caption');
        p.textContent = raw.replace(/^\[caption\]\s*/i, '');
      } else if (lower.startsWith('caption:')) {
        p.classList.add('image-caption');
        p.textContent = raw.replace(/^caption:\s*/i, '');
      }
    });

    if (tocList) {
      tocList.innerHTML = '';
      const headings = content.querySelectorAll('h2');

      headings.forEach((heading, index) => {
        const id = heading.id && heading.id.trim() ? heading.id : `section-${index}`;
        heading.id = id;

        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${id}`;
        a.textContent = heading.textContent;
        li.appendChild(a);
        tocList.appendChild(li);
      });
    }

    document.addEventListener('click', (e) => {
      const link = e.target.closest('a[href^="#"]');
      if (!link) return;

      const hash = link.getAttribute('href');
      if (!hash || hash === '#') return;

      const target = document.querySelector(hash);
      if (!target) return;

      e.preventDefault();

      const y = target.getBoundingClientRect().top + window.pageYOffset - 120;
      window.scrollTo({ top: y, behavior: 'smooth' });

      history.replaceState(null, document.title, window.location.pathname + window.location.search);
    });

    const updateOnScroll = () => {
      if (progressEl) {
        const rect = content.getBoundingClientRect();
        const top = rect.top + window.pageYOffset;
        const height = content.scrollHeight;

        const scrolled = window.pageYOffset - top + window.innerHeight;
        const progress = (scrolled / height) * 100;

        progressEl.style.width = Math.min(Math.max(progress, 0), 100) + '%';
      }

      if (tocEl) {
        if (window.scrollY >= content.offsetTop - 200) tocEl.classList.add('visible');
        else tocEl.classList.remove('visible');
      }

      const sections = content.querySelectorAll('h2');
      const tocLinks = document.querySelectorAll('.toc a');
      let current = '';

      sections.forEach((section) => {
        if (window.scrollY >= section.offsetTop - 150) current = section.id;
      });

      tocLinks.forEach((a) => {
        a.classList.toggle('active', a.getAttribute('href') === `#${current}`);
      });
    };

    let ticking = false;
    window.addEventListener('scroll', () => {
      if (ticking) return;
      ticking = true;
      window.requestAnimationFrame(() => {
        updateOnScroll();
        ticking = false;
      });
    });

    updateOnScroll();
  });
</script>

{% schema %}
{
  "name": "News Article",
  "settings": []
}
{% endschema %}
